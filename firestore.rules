// Firestore Rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- helpers ----------
    function isSignedIn() {
      return request.auth != null;
    }

    function me() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : null;
    }

    function role() {
      return me() != null ? me().role : null;
    }

    function isSuperAdmin() { return role() == 'super-admin'; }
    function isBigAdmin()   { return role() == 'big-admin'; }
    function isAdmin()      { return role() == 'admin'; }
    function isAnyAdmin()   { return isSuperAdmin() || isBigAdmin() || isAdmin(); }

    // ---------- default deny ----------
    match /{document=**} {
      allow read, write: if false;
    }

    // ---------- users ----------
    match /users/{userId} {
      // read
      allow get: if isSignedIn() && (request.auth.uid == userId || isAnyAdmin());
      allow list: if isSignedIn() && isAnyAdmin();

      // create own user doc
      allow create: if isSignedIn() && request.auth.uid == userId;

      // user may update self but not elevate role/status
      allow update: if isSignedIn() && (
        (request.auth.uid == userId &&
          // prevent changing role/status yourself
          request.resource.data.role   == resource.data.role &&
          request.resource.data.status == resource.data.status
        )
        || isAnyAdmin()
      );

      // only super-admin can delete
      allow delete: if isSignedIn() && isSuperAdmin();
    }

    // ---------- invites ----------
    match /invites/{inviteId} {
      // public read during registration
      allow get, list: if true;

      // only admins can write
      allow create, update, delete: if isSignedIn() && isAnyAdmin();
    }

    // ---------- reports ----------
    match /reports/{reportId} {
      // Anyone signed in can create, but enforce ownership on create
      allow create: if isSignedIn()
        && request.resource.data.teacherId == request.auth.uid;

      // Reads (covers get + list). Evaluated per document returned:
      // - super-admin: any
      // - big-admin: same district
      // - admin: same school
      // - user/public_user: only own docs
      allow read: if isSignedIn() && (
           isSuperAdmin()
        || (isBigAdmin() && me() != null && resource.data.district == me().district)
        || (isAdmin()    && me() != null && resource.data.schoolName == me().schoolName)
        || resource.data.teacherId == request.auth.uid
        || resource.data.ownerUid  == request.auth.uid
      );

      // Updates/deletes:
      // - super-admin: any
      // - others: only if they own the doc
      allow update, delete: if isSignedIn() && (
           isSuperAdmin()
        || resource.data.teacherId == request.auth.uid
        || resource.data.ownerUid  == request.auth.uid
      );
    }
  }
}
