
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- helpers ---
    function isSignedIn() { return request.auth != null; }
    function userDoc()    { return get(/databases/$(database)/documents/users/$(request.auth.uid)).data; }
    function userExists() { return exists(/databases/$(database)/documents/users/$(request.auth.uid)); }
    function role()       { return isSignedIn() && userExists() ? userDoc().role : null; }

    // --------------------------------------------------------------------
    // users
    // --------------------------------------------------------------------
    match /users/{userId} {
      // a user can read themself; admins can read any
      allow get:  if isSignedIn() && (request.auth.uid == userId || role() in ['super-admin','big-admin','admin']);
      // listing users is admin-only
      allow list: if isSignedIn() && role() in ['super-admin','big-admin','admin'];

      // create only your own doc
      allow create: if isSignedIn() && request.auth.uid == userId;

      // user can update themself if they don't change role; admins may update any
      allow update: if isSignedIn() && (
        (request.auth.uid == userId && request.resource.data.role == resource.data.role) ||
        role() in ['super-admin','big-admin','admin']
      );

      // only super-admin may delete
      allow delete: if isSignedIn() && role() == 'super-admin';
    }

    // --------------------------------------------------------------------
    // invites
    // --------------------------------------------------------------------
    match /invites/{inviteId} {
      // public read is fine for your signup flow; tighten to isSignedIn() if you want
      allow read: if true;
      // writes only by admins
      allow write: if isSignedIn() && role() in ['super-admin','big-admin','admin'];
    }

    // --------------------------------------------------------------------
    // reports
    // --------------------------------------------------------------------
    match /reports/{reportId} {
      // anyone signed-in can create;
      // teachers/public_user may only create docs where teacherId == their uid
      allow create: if isSignedIn() && (
        role() in ['super-admin','big-admin','admin'] ||
        (role() in ['user','public_user'] && request.resource.data.teacherId == request.auth.uid)
      );

      // get/update/delete for individual documents
      allow get, update, delete: if isSignedIn() && (
        role() == 'super-admin' ||
        (role() == 'big-admin' && resource.data.district == userDoc().district) ||
        (role() == 'admin'     && resource.data.schoolName == userDoc().schoolName) ||
        (resource.data.teacherId == request.auth.uid)
      );

      // list for queries - evaluated on the query, not per-document
      allow list: if isSignedIn() && (
          // Super-admin can list all documents without filters
          role() == 'super-admin'
          // Big-admin can list documents if the query is filtered by their district
          || (role() == 'big-admin' && request.query.get('district') == userDoc().district)
          // Admin can list documents if the query is filtered by their school
          || (role() == 'admin' && request.query.get('schoolName') == userDoc().schoolName)
          // Users can list documents if the query is filtered by their user ID
          || (role() in ['user', 'public_user'] && request.query.get('teacherId') == request.auth.uid)
      );
    }
  }
}
