// Firestore Rules
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------- helpers ----------
    function isSignedIn() {
      return request.auth != null;
    }

    function me() {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data
        : null;
    }

    function role() {
      return me() != null ? me().role : null;
    }

    function isSuperAdmin() { return role() == 'super-admin'; }
    function isBigAdmin()   { return role() == 'big-admin'; }
    function isAdmin()      { return role() == 'admin'; }
    function isAnyAdmin()   { return isSuperAdmin() || isBigAdmin() || isAdmin(); }

    // ---------- default deny ----------
    match /{document=**} {
      allow read, write: if false;
    }

    // ---------- users ----------
    match /users/{userId} {
      allow get: if isSignedIn() && (request.auth.uid == userId || isAnyAdmin());
      allow list: if isSignedIn() && isAnyAdmin();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isSignedIn() && (
        (request.auth.uid == userId &&
          request.resource.data.role   == resource.data.role &&
          request.resource.data.status == resource.data.status
        )
        || isAnyAdmin()
      );
      allow delete: if isSignedIn() && isSuperAdmin();
    }

    // ---------- invites ----------
    match /invites/{inviteId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn() && isAnyAdmin();
    }

    // ---------- reports ----------
    match /reports/{reportId} {
      // Create: enforce ownership
      allow create: if isSignedIn()
        && request.resource.data.teacherId == request.auth.uid;

      // Read: null-safe checks and role-based access
      allow read: if isSignedIn() && (
           isSuperAdmin()
        || (isBigAdmin() && me() != null
            && resource.data.district != null
            && resource.data.district == me().district)
        || (isAdmin() && me() != null
            && resource.data.schoolName != null
            && resource.data.schoolName == me().schoolName)
        || (resource.data.teacherId != null
            && resource.data.teacherId == request.auth.uid)
        || (resource.data.ownerUid != null
            && resource.data.ownerUid == request.auth.uid)
      );

      // List: simplified fallback for ownership
      allow list: if isSignedIn() && (
           (resource.data.teacherId != null
            && resource.data.teacherId == request.auth.uid)
        || (resource.data.ownerUid != null
            && resource.data.ownerUid == request.auth.uid)
      );

      // Update/Delete: super-admin or owner
      allow update, delete: if isSignedIn() && (
           isSuperAdmin()
        || (resource.data.teacherId != null
            && resource.data.teacherId == request.auth.uid)
        || (resource.data.ownerUid != null
            && resource.data.ownerUid == request.auth.uid)
      );
    }
  }
}
