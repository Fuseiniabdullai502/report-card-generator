rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // By default, deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // --- Users Collection Rules ---
    match /users/{userId} {
      // Helper function to check if the requesting user is an admin type
      function isAdmin() {
        return request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super-admin', 'big-admin', 'admin'];
      }
      
      // Allow a user to read their own document.
      allow get: if request.auth.uid == userId;

      // Allow admins to read any user's document.
      allow list: if isAdmin();
      
      // Allow a user to create their own document (e.g., on registration).
      allow create: if request.auth.uid == userId;
      
      // Allow a user to update their own document, but not change their role.
      allow update: if request.auth.uid == userId && request.resource.data.role == resource.data.role;

      // Allow admins to update any user document.
      allow update: if isAdmin();
      
      // Only super-admins can delete users.
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'super-admin';
    }

    // --- Reports Collection Rules ---
    match /reports/{reportId} {
      // Any authenticated user can create a report (e.g., a teacher).
      allow create: if request.auth != null;
      
      // Any authenticated user can read any report.
      // You can tighten this later if needed (e.g., only allow users to read reports they created or are in their school).
      allow read: if request.auth != null;
      
      // Only allow a user to update a report they created, or allow an admin to update any report.
      allow update, delete: if request.auth != null && (resource.data.teacherId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super-admin', 'big-admin', 'admin']);
    }

    // --- Invites Collection Rules ---
    match /invites/{inviteId} {
      // Anyone can read the invites collection to check if their email has a pending invite during registration.
      allow read: if true;
      
      // Only admins can create, update, or delete invites.
      allow write: if request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['super-admin', 'big-admin', 'admin'];
    }
  }
}
